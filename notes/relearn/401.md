
性能优化不能只着眼于局部的代码

__一切没有 profiling 的性能都是耍流氓__

凡是真正有价值的性能优化，必定是从端到端的业务场景建立体系来考虑的

性能体系的建立可以分成以下几个部分：
- 现状评估和建立指标
- 技术方案
- 执行
- 结果评估和监控


### 现状评估和建立指标

正确地评估现状和建立指标是最关键的一步

指标：
- 一方面，对用户来说，什么样的性能指标能更好地评估它的体验？
- 另一方面，对公司来说，什么样的指标会影响业务价值呢？

性能问题分为几个方面：
- 页面加载性能 __跟用户的流失率有非常强的关联性，而用户流失率，正是公司业务非常看重的指标__
- 动画与操作性能
- 内存、电量消耗

__“用户平均加载时间”__ 存在的问题：
- 当加载时间低于一定数字，用户体感差别不大了，经过作者团队的研究，认为这个数字大约是 1 秒
- 少数超长时间加载的用户（如 2G ），会极大影响整个指标，即指标不能反映大多数用户的体验

新的指标 ———— **秒开率**，即一秒之内打开的用户占用户总量的百分比。


### 技术方案

要想做好性能优化，绝对不能把自己限制在局部的视角，必须是整个业务一起考虑，才能有良好的收效


技术方案划分
- 缓存
  - 客户端控制的强缓存策略
- 降低请求成本
  - HTTP DNS：由客户端控制，隔一段时间主动请求 DNS 获取域名 IP，不走系统的 DNS
  - TCP/TLS 连接复用：由服务端升级到 HTTP2（当时我们做的时候还是 SPDY），尽量合并域名
- 减少请求数
  - Javascript、CSS 打包到 HTML
  - 用 Javascript 控制图片异步加载和懒加载
  - 小型图片使用 data-uri
- 减少传输体积
  - 尽量使用 SVG\gradient 等代替图片
  - 根据机型和网络状况控制图片清晰度
  - 对低清晰图片使用锐化来提升体验
  - 设计上避免大型背景图

### 执行

执行也不简单，如果说方案主要靠技术，那么执行就是靠工程实施了。

工程水平从低到高分成三个阶段：
- 纯管理，纯行政管理，是由经理用纯粹的管理手段来执行方案
  - 问题一，需要的行政资源不一定有
  - 问题二，纯粹的管理方式，团队体验不好，不利于团队成长，最重要的是，纯粹管理方式容易造成执行不到位。
  - 该方式执行方式多数出现在非技术岗位
- 制度化，用规则代替人的命令，指定责任人，通过培训、`checklist`、定期 `review` 等具体措施来保证。
  - 制度化执行可以极大地减轻管理工作量，一般现代互联网公司都会采用类似方式
  - 还有很大成分依靠人的主动性
- 自动化，在一些重要的操作路径上设置规则，针对我们的性能优化，有 2 个点适合做
  - 一个是把开发好的页面发布上线
  - 一个是开发好的页面 URL 投放到首页等处的链接

>在我之前的工作中，我们跟测试团队配合，开发了一套页面性能打分系统，它会自动扫面页面上的可优化点，并且跟发布平台和投放平台合作，把它加入日常机制中。现在多数公司都会采用制度化和自动化结合的执行方案


### 结果评估和监控

执行之后，还要有一定的结果总结，才是一个完整的工程实施，而且，凡是工程实施，肯定要有一定长效机制，不能优化完了退化，这些都要求有线上监控机制

线上监控，分 2 个部分：
- 数据采集，需要发布平台或者开发工具来配合，性能数据可以利用 `Performance API` ，是浏览器记录的性能数据。一般来说可用统一的代码把它上传到服务器端就够用了
- 数据展现，数据可视化处理，考虑如一般的数据监控平台提供报警机制，对性能来说，报警需求不是很强烈，可设置条件针对秒开率特别低的页面报警

性能不是一个静态的事情，指标需要不断优化，技术方案还需要不断随着技术发展迭代，制度、自动化工具也需要不断改进


性能应该是基于业务和实际用户体验需求的一种工程实施，不是纯粹的技术游戏







